# セキュリティガイド

## ⚠️ 重要：`VITE_` プレフィックスについて

### Vite の環境変数の仕組み

```typescript
// VITE_ で始まる環境変数
VITE_SUPABASE_URL=https://xxx.supabase.co

// → ビルド時にJavaScriptバンドルに埋め込まれる
// → ブラウザの開発者ツールで誰でも見られる 🚨
```

### 安全な環境変数 vs 危険な環境変数

| 環境変数                            | `VITE_`     | 安全性  | 理由                   |
| ----------------------------------- | ----------- | ------- | ---------------------- |
| `VITE_SUPABASE_URL`                 | ✅ 使用可能 | ✅ 安全 | 公開 URL               |
| `VITE_SUPABASE_ANON_KEY`            | ✅ 使用可能 | ✅ 安全 | 匿名キー（RLS で保護） |
| `VITE_STRIPE_PUBLISHABLE_KEY`       | ✅ 使用可能 | ✅ 安全 | 公開可能なキー         |
| `VITE_GORSE_ENDPOINT`               | ✅ 使用可能 | ✅ 安全 | 公開 URL               |
| ❌ `VITE_OPENAI_API_KEY`            | ❌ 使用禁止 | ❌ 危険 | API キーは秘密にすべき |
| ❌ `VITE_SUPABASE_SERVICE_ROLE_KEY` | ❌ 使用禁止 | ❌ 危険 | 管理者権限のキー       |

### ✅ ルール

1. **公開しても問題ない情報のみ `VITE_` を使用**
2. **API キーや秘密鍵は絶対に `VITE_` をつけない**
3. **秘密情報はサーバー側（Supabase Edge Functions 等）で管理**

---

## 🔒 環境変数の管理

### 現在の状況

- ✅ `.env` ファイルは `.gitignore` に含まれている
- ✅ コード内では環境変数を使用している
- ⚠️ 一部のスクリプトでハードコードされた API キーが存在

### 推奨事項

#### 1. 環境変数の設定

```bash
# ローカル開発用
cp .env.example .env
# .env ファイルに実際の値を設定
```

#### 2. 本番環境での設定

- **Vercel**: ダッシュボードで環境変数を設定
- **Supabase**: プロジェクト設定で環境変数を設定
- **EC2**: システム環境変数または `.env` ファイルを使用

#### 3. API キーの管理

- 定期的に API キーをローテーション
- 最小権限の原則に従う
- 不要な API キーは削除

#### 4. セキュリティチェックリスト

- [ ] `.env` ファイルが Git にコミットされていない
- [ ] 本番環境で環境変数が正しく設定されている
- [ ] API キーがハードコードされていない
- [ ] 不要な API キーが削除されている

## 🚨 緊急対応が必要な項目

1. **vercel-env-vars.txt の削除** ✅ 完了
2. **.gitignore の更新** ✅ 完了
3. **.env.example の作成** ✅ 完了

## 📋 今後の改善点

1. **環境変数の検証**

   - アプリケーション起動時に環境変数の存在を確認
   - 不正な値の検出とログ出力

2. **API キーのローテーション**

   - 定期的な API キーの更新
   - 複数の API キーの管理

3. **監査ログ**
   - API キーの使用状況の監視
   - 異常なアクセスの検出
