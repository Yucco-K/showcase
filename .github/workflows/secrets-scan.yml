name: Secrets Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  gitleaks:
    name: Gitleaks Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆéŽåŽ»ã®ã‚³ãƒŸãƒƒãƒˆã‚‚ã‚¹ã‚­ãƒ£ãƒ³ï¼‰

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_SUMMARY: true

      - name: Upload Gitleaks Report
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 30

  trufflehog:
    name: TruffleHog Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified
        continue-on-error: true

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## ðŸ” Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Gitleaks: ${{ needs.gitleaks.result }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… TruffleHog: ${{ needs.trufflehog.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.gitleaks.result }}" == "failure" ] || [ "${{ needs.trufflehog.result }}" == "failure" ]; then
            echo "âš ï¸ **Warning**: Potential secrets detected!" >> $GITHUB_STEP_SUMMARY
            echo "Please review the scan results and remove any sensitive information." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ¨ No secrets detected. Safe to proceed!" >> $GITHUB_STEP_SUMMARY
          fi
